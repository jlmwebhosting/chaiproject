<div class="topbar">
	<div class="topbar-inner">
		<div class="container">
			<a class="brand" href="#index"></a>
			<ul class="nav">
			</ul>
			<ul class="nav secondary-nav">
			</ul>
		</div>
	</div>
</div>

<script>
$.require('lib/js/bootstrap/bootstrap-dropdown.js');
$(document).ready(function() {
	
	var render_topbar = function() {
		var user = $.session.user;

		// clear out if there is anything
		$('.topbar .nav.secondary-nav').empty();
		if(!user || user=='guest') {
			$('.topbar .nav.secondary-nav').append('\
				<li><a href="#signin">Login</a></li>\
			')
		}
		
		// if not guest and admin
		if(user && user!='guest') {
			// edit links for admins
			if($.session.userobj.is_admin) {
				$('.topbar .nav.secondary-nav').append('\
					<li class="dropdown">\
						<a class="dropdown-toggle" href="#">Admin</a>\
						<ul class="dropdown-menu">\
							<li><a href="#pagelist">Pages</a></li>\
							<li><a href="#filelist">Files</a></li>\
							<li><a href="#userlist">Users</a></li>\
						</ul>\
					<li>');
			}
			// user profile and logout
			$('.topbar .nav.secondary-nav').append('\
			<li class="dropdown">\
				<a class="dropdown-toggle" href="#">'
					+($.session.userobj.fullname || 'User')+'</a>\
				<ul class="dropdown-menu">\
					<li><a href="#editprofile">Edit Profile</a></li>\
					<li><a href="#" id="topbar_logout">Logout</a></li>\
				</ul>\
			<li>')

			// logout
			$('#topbar_logout').click($.logout);			
		}
		$('.topbar').dropdown();
	}

	// set brand
	$('.topbar .brand').html($.app_name);

	// bind render_topbar to the session
	$(document).bind('session_load', render_topbar);
	
	// $.logout function
	// logs out user and reload the page
	(function($) {
		$.logout = function() {
			$.ajax({
				url:'lib/py/session.py', 
				type:'DELETE', 
				success: function(data) {
					$(document).trigger('logout');
				}
			});
			return false;
		}
	})(jQuery);
	
	// reload page on logout
	$(document).bind('logout', function() {
		window.location.reload(true);
	})
	
	$.getJSON('lib/py/session.py', function(session) {
		$.session = session

		// trigger session_load
		$(document).trigger('session_load');
	})
})

</script>